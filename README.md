# MuTune Backend

PDF 악보를 업로드하면 MusicXML로 변환하고,  
코드와 가사를 정렬하여 재구성하는 음악 처리 백엔드 프로젝트입니다.

단순 파일 업로드 서버가 아니라  
이미지 전처리 → OMR → 텍스트 분석 → 정렬 알고리즘 → XML 재조립까지  
하나의 파이프라인으로 설계했습니다.

---

## Tech Stack

- Java 21
- Spring Boot 3.3
- Spring Security
- JWT (Access / Refresh Token)
- JPA (Hibernate)
- MySQL
- Gradle
- Python (OpenCV, pdfplumber)
- Audiveris CLI
- XML 처리 (ElementTree)

---

## 인증 및 로그인 구조

### JWT 기반 인증

- Spring Security + JWT 적용
- Access Token / Refresh Token 구조
- Stateless 인증 방식
- JWT 필터를 통한 요청 검증
- 토큰 만료 시 Refresh 로직 구현

### 로그인 기능

- OAuth2 기반 소셜 로그인 구조 설계 (Google, Kakao 확장 가능)
- 사용자 정보 DB 저장
- CustomUserDetails 구현
- SecurityConfig 분리 설계

### 보안 설계

- 인증이 필요한 API와 공개 API 분리
- PasswordEncoder 적용
- CORS 설정
- 토큰 기반 권한 제어

---

## 파일 처리 구조

- UUID 기반 세션 디렉토리 생성
- 업로드 단위가 아닌 작업 세션 단위 관리
- 모든 중간 산출물 추적 가능하도록 설계


---

## 악보 처리 파이프라인

1. PDF 업로드
2. 이미지 전처리 (기울기 보정, 노이즈 제거)
3. Audiveris OMR 실행
4. PDF 텍스트 레이어 분석
5. 코드 및 가사 추출
6. x좌표 기반 시간 정규화
7. Dynamic Programming 기반 가사 정렬
8. MusicXML 재조립

---

## 시행착오와 설계 변화 과정 (5개월)

이 프로젝트는 초기 설계가 그대로 유지된 것이 아니라, 여러 차례 구조를 변경하며 개선되었습니다.

### 1. 이미지 기반 전체 처리 시도

초기에는 PDF를 이미지로 변환한 뒤, OMR로 음표와 가사, 코드를 모두 인식하는 방식을 시도했습니다.

문제점:
- Audiveris는 음표 인식은 가능했지만 가사 정확도가 낮았음
- 코드(chord symbol) 인식률이 불안정
- 이미지 왜곡과 해상도에 따라 결과 편차가 큼

이미지 기반 일괄 처리 방식은 안정성이 부족하다고 판단했습니다.

---

### 2. OMR + OCR 혼합 방식

음표는 Audiveris, 가사와 코드는 OCR로 별도 추출하여 병합하는 방식을 시도했습니다.

문제점:
- 워터마크 및 저작권 문구가 대량 혼입
- 코드 fragment 분해 문제 (예: C / m / 7)
- 줄바꿈 시 x좌표 단조 증가가 깨짐
- 최근접 매칭 방식의 구조적 한계

특히 줄이 바뀌는 순간 정렬이 붕괴되는 문제가 발생했습니다.

---

### 3. 최종 구조 선택

구조를 재설계했습니다.

- 음표는 Audiveris XML에서 직접 추출
- 가사 및 코드는 PDF 텍스트 레이어에서 추출 (pdfplumber)
- 단순 x좌표 매칭이 아닌 (measure, offset) 기준으로 재정의

좌표의 절대값이 아닌, 음악적 시간 개념으로 변환하는 방식으로 전환했습니다.

---

## 정렬 알고리즘 개선

문제:
- x좌표는 줄이 바뀌면 다시 초기화됨
- 단순 거리 기반 매칭은 정확도가 낮음

해결:
- page + system 단위 그룹화
- Hard Anchor 기준점 도입
- 좌/우 분리 정렬 방식 적용
- Dynamic Programming 기반 비용 함수 설계
- note capacity rule 적용

단순 최근접 매칭이 아니라 구조적 정렬 방식으로 개선했습니다.

---

## 구현 과정에서 해결한 주요 문제

- 줄바꿈 시 x좌표 단조 증가 깨짐 문제
- 코드 fragment 분해 및 병합 문제
- slash chord 병합 문제
- 가사 밀림 현상
- 워터마크 및 저작권 텍스트 혼입

좌표 간격과 문맥을 함께 고려하는 병합 로직을 구현하여 개선했습니다.

---

## 현재 상태

- PDF → MusicXML 변환 가능
- 코드 및 가사 자동 정렬 가능
- 프론트엔드 연동 완료
- JWT 기반 로그인 구현 완료

악보 처리 알고리즘은 현재도 정확도 개선을 진행 중이며, 다양한 악보 유형에 대한 안정성 보완 작업을 수행하고 있습니다.

---

## 향후 계획

### SaaS 구조 고도화

- 결제 시스템 도입
- 구독 모델 설계
- 사용자 작업 기록 관리
- 클라우드 환경 배포

### MR 키/템포 편집 기능

- 오디오 파일 업로드
- Pitch Shift / Tempo Change 처리
- Web 기반 MR 편집 도구 구현

### AI 원터치 믹싱 기능

- 보컬 및 악기 트랙 분석
- 자동 EQ / Compression / Balance 처리
- 초보자도 사용할 수 있는 원클릭 믹싱 구조 목표

---

## 프로젝트 목적

이 프로젝트는 단순 CRUD 구현을 넘어서 다음을 경험하기 위해 진행했습니다.

- 파일 기반 데이터 파이프라인 설계
- 외부 프로그램 연동 자동화
- 좌표 기반 정렬 알고리즘 구현
- 보안 인증 구조 설계

아직 완성 단계는 아니지만, 실제 서비스화를 목표로 구조를 설계하고 지속적으로 개선하고 있습니다.
